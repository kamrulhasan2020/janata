<script>
$(document).ready(function(){
  $.get("{% url 'main:trades'%}", function(data, status){
      var tbl = '';
      console.log(data);
      table_data = data['results']
      tbl +='<table class="table table-hover">'
          tbl +='<thead>';
              tbl +='<tr>';
              tbl +='<th>Date</th>';
              tbl +='<th>Trade Code</th>';
              tbl +='<th>High</th>';
              tbl +='<th>Low</th>';
              tbl +='<th>Open</th>';
              tbl +='<th>Close</th>';
              tbl +='<th>Volume</th>';
              tbl +='</tr>';
          tbl +='</thead>';
          tbl +='<tbody id="tbody">';
          $.each(table_data, function(index, val)
              {
                  var row_id = val['pk']
                  tbl +='<tr display="block" id="'+row_id+'" row_id="'+row_id+'">';
                      tbl +='<td ><div class="row_data" edit_type="click" col_name="date">'+val['date']+'</div></td>';
                      tbl +='<td ><div class="row_data" edit_type="click" col_name="trade_code">'+val['trade_code']+'</div></td>';
                      tbl +='<td ><div class="row_data" edit_type="click" col_name="high">'+val['high']+'</div></td>';
                      tbl +='<td ><div class="row_data" edit_type="click" col_name="low">'+val['low']+'</div></td>';
                      tbl +='<td ><div class="row_data" edit_type="click" col_name="open">'+val['open']+'</div></td>';
                      tbl +='<td ><div class="row_data" edit_type="click" col_name="close">'+val['close']+'</div></td>';
                      tbl +='<td ><div class="row_data" edit_type="click" col_name="volume">'+val['volume']+'</div></td>';
                      tbl +='<td>';
                      tbl += '<button type="button" edit_type="button" class="btn btn-outline-danger" id="delete_button">Delete</button>';
                      tbl +='</td>';
                  tbl +='</tr>';
              });
      tbl +='</tbody>';
      tbl +='</table>'
      $('.tbl_user_data').html(tbl);
  });
  $.ajax({
      type: "GET",
      url: "{% url 'main:chart' %}",
      success: function (data) {
        var options = {
        series: [{
        name: 'Volume',
        type: 'column',
        data: data['data2']
      }, {
        name: 'Close',
        type: 'line',
        data: data['data']
      }],
        chart: {
        height: 350,
        type: 'line',
      },
      stroke: {
        width: [0, 4]
      },
      title: {
        text: "close-volume-date"
      },
      dataLabels: {
        enabled: false,
        enabledOnSeries: [1]
      },
      labels: data['labels'],
      xaxis: {
        type: 'date',
      },
      yaxis: [{
        title: {
          text: 'Volume',
        },

      }, {
        opposite: true,
        title: {
          text: 'Close',
        }
      }]
      };

      var chart = new ApexCharts(document.querySelector("#all_chart"), options);
      chart.render();

    }
    });
  $(document).on('click', '.dropdown-item', function(event){
    event.preventDefault();
    $('#all_chart').css('display', 'none');
    var code = $(this).attr('trade_code');
    $('#trade_code_in').val(code);
    $('#code_viewer').text(code);
    var trades_url = "trade/" + code;
    $.get(trades_url, function(data, status){
        var tbl = '';
        tbl +='<table class="table table-hover">'
            tbl +='<thead>';
                tbl +='<tr>';
                tbl +='<th>Date</th>';
                tbl +='<th>Trade Code</th>';
                tbl +='<th>High</th>';
                tbl +='<th>Low</th>';
                tbl +='<th>Open</th>';
                tbl +='<th>Close</th>';
                tbl +='<th>Volume</th>';
                tbl +='</tr>';
            tbl +='</thead>';
            tbl +='<tbody id="tbody">';
            $.each(data, function(index, val)
                {
                    var row_id = val['pk']
                    tbl +='<tr display="block" id="'+row_id+'" row_id="'+row_id+'">';
                        tbl +='<td ><div class="row_data" edit_type="click" col_name="date">'+val['date']+'</div></td>';
                        tbl +='<td ><div class="row_data" edit_type="click" col_name="trade_code">'+val['trade_code']+'</div></td>';
                        tbl +='<td ><div class="row_data" edit_type="click" col_name="high">'+val['high']+'</div></td>';
                        tbl +='<td ><div class="row_data" edit_type="click" col_name="low">'+val['low']+'</div></td>';
                        tbl +='<td ><div class="row_data" edit_type="click" col_name="open">'+val['open']+'</div></td>';
                        tbl +='<td ><div class="row_data" edit_type="click" col_name="close">'+val['close']+'</div></td>';
                        tbl +='<td ><div class="row_data" edit_type="click" col_name="volume">'+val['volume']+'</div></td>';
                        tbl +='<td>';
                        tbl += '<button type="button" edit_type="button" class="btn btn-outline-danger" id="delete_button">Delete</button>';
                        tbl +='</td>';
                    tbl +='</tr>';
                });
        tbl +='</tbody>';
        tbl +='</table>'
        $('.tbl_user_data').html(tbl);
    });
    $.ajax({
        type: "POST",
        url: "{% url 'main:chart' %}",
        headers: {'X-CSRFToken': '{{ csrf_token }}', 'Accept':'application/json'},
        data: {
          'trade_code': code
        },
        success: function (data) {
          var options = {
          series: [{
          name: 'Volume',
          type: 'column',
          data: data['data2']
        }, {
          name: 'Close',
          type: 'line',
          data: data['data']
        }],
          chart: {
          height: 350,
          type: 'line',
        },
        stroke: {
          width: [0, 4]
        },
        title: {
          text: "close/volume/date"
        },
        dataLabels: {
          enabled: false,
          enabledOnSeries: [1]
        },
        labels: data['labels'],
        xaxis: {
          type: 'date',
        },
        yaxis: [{
          title: {
            text: 'Volume',
          },

        }, {
          opposite: true,
          title: {
            text: 'Close',
          }
        }]
        };

        var chart2 = new ApexCharts(document.querySelector("#code_chart"), options);
        chart2.render();

      }
      });
  });
  $(document).on('click', '.row_data', function(event)
  {
    event.preventDefault();
      if($(this).attr('edit_type') == 'button')
    {
      return false;
    }
    $(this).closest('div').attr('contenteditable', 'true');
    $(this).addClass('bg-warning').css('padding','5px');
    $(this).focus();
  });
  $(document).on('focusout', '.row_data', function(event)
  {
    event.preventDefault();

    if($(this).attr('edit_type') == 'button')
    {
      return false;
    }

    var row_id = $(this).closest('tr').attr('row_id');

    var row_div = $(this)
    .removeClass('bg-warning') //add bg css
    .css('padding','')

    var col_name = row_div.attr('col_name');
    var col_val = row_div.html();

    var arr = {};
    arr[col_name] = col_val;

    $.extend(arr, {row_id:row_id});
      $.ajax({
          type: "POST",
          url: "{% url 'main:update' %}",
          headers: {'X-CSRFToken': '{{ csrf_token }}', 'Accept':'application/json'},
          data: {
            'pk':row_id,
            'attr':col_name,
            'val':col_val
          },
          success: function () {
              return false;
          }
        });
      });
      $(document).on('click', '#delete_button', function(event)
      {
          event.preventDefault();
          var row_id = $(this).closest('tr').attr('row_id');
          $.ajax({
              type: "POST",
              url: "{% url 'main:delete' %}",
              headers: {'X-CSRFToken': '{{ csrf_token }}', 'Accept':'application/json'},
              data: {
                'pk':row_id
              },
              success: function () {
                  row = '#' + row_id;
                  $(row).hide();
              }
            });
      });
      $(document).on('click', '#new_entry', function(event){
        event.preventDefault();
        $("#form_holder").css('display', 'block');
        $("#cancel").css('display', 'block');
        $(this).css('display', 'none');
      });
      $(document).on('click', '#cancel', function(event){
        event.preventDefault();
        $("#form_holder").css('display', 'none');
        $("#new_entry").css('display', 'block');
        $(this).css('display', 'none');
      });

      $(document).on('click', '#entry_submit', function(even){
        event.preventDefault();
        $.ajax({
            type: "POST",
            processData: false,
            contentType: false,
            cache: false,
            url: "{% url 'main:trades' %}",
            headers: {'X-CSRFToken': '{{ csrf_token }}', 'Accept':'application/json'},
            data: new FormData($('#new_entry_form')[0]),
            success: function () {
              $.get("{% url 'main:latest_entry' %}", function(data, status){
                $("#form_holder").css('display', 'none');
                $('#new_entry_form')[0].reset();
                var new_data = '<tr display="block" id="'+data.pk+'" row_id="'+data.pk+'">'
                new_data += '<td ><div class="row_data" edit_type="click" col_name="date">'+data.date+'</div></td>';
                new_data += '<td ><div class="row_data" edit_type="click" col_name="trade_code">'+data.trade_code+'</div></td>';
                new_data += '<td ><div class="row_data" edit_type="click" col_name="high">'+data.high+'</div></td>';
                new_data += '<td ><div class="row_data" edit_type="click" col_name="low">'+data.low+'</div></td>';
                new_data += '<td ><div class="row_data" edit_type="click" col_name="open">'+data.open+'</div></td>';
                new_data += '<td ><div class="row_data" edit_type="click" col_name="close">'+data.close+'</div></td>';
                new_data += '<td ><div class="row_data" edit_type="click" col_name="volume">'+data.volume+'</div></td>';
                new_data +='<td>';
                new_data += '<button type="button" edit_type="button" class="btn btn-outline-danger" id="delete_button">Delete</button>';
                new_data +='</td>';
                new_data +='</tr>';
                $('#tbody').prepend(new_data);
                });
            }
          });
      });
});



</script>



</html>
